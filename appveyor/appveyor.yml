version: 1.6.{build}

pull_requests:
  do_not_increment_build_number: false
max_jobs: 2
build: false
matrix:
  fast_finish: true

environment:
  SQLINSTANCE: "localhost"
  DATABASE: "tsqlt"
  access_token:
    secure: "E5I+i+CQyj9EHusDrPSQKHRXmzmpTujYAoFxlvJjvSRSEQHHzqTBIFR1VuPbwLMi"
  APPVEYOR_RDP_PASSWORD: Np^VNSzJI5#OmRdUNqro2T9UVkCdZ
  INSTALLER_FILE: "install_dba-multitool.sql"

  matrix:
    - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
      MSSQL: SQL2016
      DB_INSTANCE: localhost\SQL2016
      LATEST: False
      AzureSQL: False

    - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015
      MSSQL: SQL2014
      DB_INSTANCE: localhost\SQL2014
      LATEST: False
      AzureSQL: False

clone_script:
  - git config --global credential.helper store
  - ps: Add-Content "$HOME\.git-credentials" "https://$($env:access_token):x-oauth-basic@github.com`n" -NoNewLine
  - git config --global user.email "appveyor@lowlydba.com"
  - git config --global user.name "Appveyor"
  - git config --global core.safecrlf false
  - git clone -q --single-branch --branch=%APPVEYOR_PULL_REQUEST_HEAD_REPO_BRANCH% https://github.com/LowlyDBA/dba-multitool.git %APPVEYOR_BUILD_FOLDER%
  - cd %APPVEYOR_BUILD_FOLDER%

install:
  - ps: .\appveyor\install_dependencies.ps1
  - ps: .\appveyor\start_sqlserver.ps1
  - ps: .\appveyor\install_tsqlt.ps1
  # - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))

test_script:
  - ps: .\appveyor\run_pester_tests.ps1
